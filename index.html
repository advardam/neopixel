<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Atomic Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0f0f1a; color: #fff; font-family: sans-serif; }
        .card { background: #1a1a2e; border: 1px solid #333; margin-bottom: 15px; }
        .mode-btn { width: 100%; margin: 5px 0; text-align: left; }
        .sensor-val { font-size: 24px; color: #00d2ff; }
        #bandCanvas, #photoCanvas { background: #222; width: 100%; height: 150px; border-radius: 5px;}
        .scroll-box { max-height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h4 class="text-center mb-4">⚛️ Smart Atomic Model</h4>

        <!-- SENSORS -->
        <div class="row text-center mb-3">
            <div class="col-4"><small>TEMP</small><br><span id="ui-temp" class="sensor-val">--</span> °C</div>
            <div class="col-4"><small>SOLAR</small><br><span id="ui-solar" class="sensor-val">--</span></div>
            <div class="col-4"><small>CURRENT</small><br><span id="ui-amps" class="sensor-val text-warning">--</span> µA</div>
        </div>

        <div class="row">
            <!-- MENU -->
            <div class="col-md-4">
                <div class="card p-3">
                    <button onclick="setMode(1)" class="btn btn-outline-primary mode-btn">1. Electron Config</button>
                    <button onclick="setMode(2)" class="btn btn-outline-info mode-btn">2. Quantum Trans</button>
                    <button onclick="setMode(3)" class="btn btn-outline-danger mode-btn">3. Thermodynamics</button>
                    <button onclick="setMode(4)" class="btn btn-outline-warning mode-btn">4. Photoelectric</button>
                    <button onclick="setMode(5)" class="btn btn-outline-success mode-btn">5. Band Theory</button>
                    <button onclick="setMode(6)" class="btn btn-outline-secondary mode-btn">6. Radioactivity</button>
                </div>
            </div>

            <!-- CONTROLS -->
            <div class="col-md-8">
                <div class="card p-3">
                    <h4 id="mode-title">Control Panel</h4>
                    <div id="controls-area"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mode = 1, decayChart = null, graphData = [], graphLabels = [];
        
        // --- DATA INJECTION ---
        // We inject the list of elements from Python into JS array
        const allElements = {{ elem_list|tojson }}; 

        // --- HTML SNIPPETS ---
        const controls = {
            1: `<h6>Select Element (1-18)</h6>
                <div class="scroll-box d-grid gap-2">
                   ${allElements.map(e => `<button onclick="loadElem('${e}')" class="btn btn-sm btn-secondary">${e}</button>`).join('')}
                </div>`,
            
            2: `<h6>Quantum Transitions</h6>
                <div class="mb-3">
                    <label>Base Element:</label>
                    <select class="form-select bg-dark text-white" onchange="setMode2Base(this.value)">
                        <option value="Hydrogen">Hydrogen</option>
                        <option value="Helium">Helium</option>
                        <option value="Lithium">Lithium</option>
                    </select>
                </div>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" onchange="toggleMode2(this)" checked>
                  <label class="form-check-label">Demo Mode</label></div>
                <div id="mode2-demo" class="d-grid gap-2">
                   <button onclick="simMode2('Red')" class="btn btn-danger">Excitation (Red - Low)</button>
                   <button onclick="simMode2('Blue')" class="btn btn-primary">Excitation (Blue - Med)</button>
                   <button onclick="simMode2('Violet')" class="btn" style="background-color:purple; color:white;">Excitation (Violet - High)</button>
                   <hr>
                   <button onclick="simMode2('White')" class="btn btn-light text-dark">⬇️ De-excitation (White Card)</button>
                </div>
                <div id="mode2-real" style="display:none" class="alert alert-info">Scan Cards: Red, Blue, Violet or White.</div>`,
            
            3: `<h6>Heat</h6><div class="progress"><div id="temp-bar" class="progress-bar bg-danger" style="width: 0%"></div></div>`,
            
            4: `<h6>Photoelectric Effect</h6>
                <div class="alert alert-warning">Intensity: <span id="solar-live">0</span></div>
                <canvas id="photoCanvas"></canvas>`,
            
            5: `<h6>Band Gap</h6><canvas id="bandCanvas"></canvas>`,
            
            6: `<h6>Geiger Counter</h6>
                <div class="alert alert-dark"><span style="color:#ffa;">● Alpha</span> <span style="color:#08f;">⚡ Beta</span></div>
                <label>Half-Life: <span id="hl-disp">10</span>s</label>
                <input type="range" class="form-range" min="5" max="30" value="10" onchange="setHL(this.value)">
                <button onclick="startDecay()" class="btn btn-danger w-100 mt-2">☢️ START DECAY ☢️</button>
                <h3 class="text-center mt-2" id="nucleons-disp" style="color:#0f0">43</h3>
                <canvas id="decayChart"></canvas>`
        };

        function setMode(m) {
            mode = m; document.getElementById('mode-title').innerText = "Mode " + m;
            document.getElementById('controls-area').innerHTML = controls[m];
            fetch('/set_mode/' + m);
            if(m===6) initChart(); 
            if(m===5) startBandAnim();
            if(m===4) startPhotoAnim();
        }

        // --- MODE 2 ---
        function toggleMode2(el) {
            let demo = el.checked;
            document.getElementById('mode2-demo').style.display = demo ? 'grid' : 'none';
            document.getElementById('mode2-real').style.display = demo ? 'none' : 'block';
            fetch('/mode2/set_type/' + (demo ? 'demo' : 'real'));
        }
        function simMode2(c) { fetch('/mode2/sim/' + c); }
        function setMode2Base(val) { fetch('/mode2/set_base/' + val); }

        // --- MODE 1 ---
        function loadElem(e) { fetch('/mode1/load/' + e); }

        // --- MODE 6 ---
        function setHL(v) { document.getElementById('hl-disp').innerText = v; fetch('/mode6/set_halflife/' + v); }
        function startDecay() { fetch('/mode6/start'); graphData=[]; graphLabels=[]; decayChart.update(); }

        // --- UPDATE LOOP ---
        setInterval(() => {
            fetch('/get_data').then(r => r.json()).then(data => {
                document.getElementById('ui-temp').innerText = data.temp;
                document.getElementById('ui-solar').innerText = data.solar;
                document.getElementById('ui-amps').innerText = data.photo_current;
                
                if(mode===3) document.getElementById('temp-bar').style.width = Math.min(100,(data.temp-25)*20)+"%";
                if(mode===4 && document.getElementById('solar-live')) document.getElementById('solar-live').innerText = data.solar;
                
                if(mode===6 && decayChart) {
                    if(document.getElementById('nucleons-disp')) document.getElementById('nucleons-disp').innerText = data.decay_count;
                    
                    if(data.decay_running) {
                        let t = new Date().toLocaleTimeString().split(' ')[0];
                        graphLabels.push(t); graphData.push(data.decay_count);
                        if(graphLabels.length>20){graphLabels.shift();graphData.shift();}
                        decayChart.data.labels=graphLabels; decayChart.data.datasets[0].data=graphData; decayChart.update('none'); // 'none' for smooth
                    }
                }
            });
        }, 500);

        function initChart() {
            decayChart = new Chart(document.getElementById('decayChart'), {
                type: 'line', data: { labels:[], datasets:[{label:'Nucleons', data:[], borderColor:'#0f0', tension: 0.4}]}
            });
        }

        // --- ANIMATIONS ---
        function startPhotoAnim() {
            const cvs = document.getElementById('photoCanvas'); const ctx = cvs.getContext('2d');
            cvs.width = cvs.offsetWidth; cvs.height = 150;
            let electrons = [];
            let photons = [];
            
            function draw() {
                if(mode!==4) return;
                ctx.clearRect(0,0,cvs.width,cvs.height);
                
                // Metal Plate
                ctx.fillStyle="#555"; ctx.fillRect(0, 140, cvs.width, 10);
                
                let solar = parseInt(document.getElementById('ui-solar').innerText||0);
                let active = solar > 50;
                
                // Photons (Yellow lines down)
                if(active && Math.random()>0.8) photons.push({x: Math.random()*cvs.width, y:0});
                ctx.strokeStyle = "#ff0"; ctx.lineWidth=2;
                photons.forEach((p,i) => {
                    p.y += 10; 
                    ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x-5, p.y-10); ctx.stroke();
                    if(p.y > 140) {
                        photons.splice(i,1);
                        if(solar > 100) electrons.push({x: p.x, y: 140}); // Emit electron on impact
                    }
                });

                // Electrons (Blue dots up)
                ctx.fillStyle = "#0ff";
                electrons.forEach((e,i) => {
                    e.y -= 2; e.x += (Math.random()-0.5)*2;
                    ctx.beginPath(); ctx.arc(e.x, e.y, 3, 0, 6.28); ctx.fill();
                    if(e.y < 0) electrons.splice(i,1);
                });

                requestAnimationFrame(draw);
            }
            draw();
        }

        function startBandAnim() {
            const cvs = document.getElementById('bandCanvas'); const ctx = cvs.getContext('2d');
            cvs.width = cvs.offsetWidth; cvs.height = 150;
            let elecs = Array(10).fill().map(()=>({x:Math.random()*cvs.width, y:130}));
            function draw() {
                if(mode!==5) return;
                ctx.fillStyle="#444"; ctx.fillRect(0,0,cvs.width,150);
                ctx.fillStyle="#222"; ctx.fillRect(0,50,cvs.width,50); // Gap
                let solar = parseInt(document.getElementById('ui-solar').innerText||0);
                let active = solar > 180;
                ctx.fillStyle = active ? "#ff0" : "#00f";
                elecs.forEach(e => {
                    if(active && e.y>25) e.y-=5; else if(!active && e.y<130) e.y+=5;
                    if(active && e.y<=25) e.x=(e.x+5)%cvs.width;
                    ctx.beginPath(); ctx.arc(e.x,e.y,5,0,6.28); ctx.fill();
                });
                requestAnimationFrame(draw);
            }
            draw();
        }
    </script>
</body>
</html>